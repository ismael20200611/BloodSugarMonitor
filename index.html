<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blood Sugar</title>
  <link rel="stylesheet" href="style.css" />
  <script src="script.js"></script>
</head>
<body>
  <div class="container">
    <h2>Blood Sugar Monitor</h2>
    <div id="dateTimeDisplay"> Loading current time...</div>
    <input type="text" id="fullName" placeholder="Full Name (optional)" />
    <input type="number" id="age" placeholder="Age (optional)" />
    <select id="gender">
      <option value="">Gender (optional)</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
    <input type="text" id="city" placeholder="City (optional)" />
    <input type="text" id="phone" placeholder="Phone Number (optional)" />
    <input type="email" id="email" placeholder="Email (optional)" />
    <select id="diabetesType" required>
      <option value="none">-- Select Diabetes Type --</option>
      <option value="type1">Type 1 Diabetes</option>
      <option value="type2">Type 2 Diabetes</option>
      <option value="gestational">Gestational Diabetes</option>
      <option value="prediabetes">Pre-diabetes</option>
    </select>
    <select id="unit">
      <option value="mgdl">mg/dL</option>
      <option value="mmol">mmol/L</option>
    </select>
    <input type="number" id="reading" placeholder="Enter blood sugar reading" min="0" required />
    <button id="checkBtn">Check Blood Sugar</button>
    <button id="downloadCsv">üì• Download CSV</button>
    <button id="printResults">üñ®Ô∏è Print Results</button>

    <div id="result" style="display:none;"></div>
    <h3>üìú Last 100 Checks</h3>
    <div id="history"></div>
  </div>

  <footer>
    ‚ÑπÔ∏è This tool is for personal tracking and educational purposes only.<br>
    It does not replace professional medical diagnosis, insulin management, or emergency care.
  </footer>

  <script>
    
    function refreshHistory() {
      const historyBox = document.getElementById("history");
      const history = JSON.parse(localStorage.getItem("sugarHistory") || "[]");
      historyBox.innerHTML = buildTable(history);
    }

    document.getElementById("checkBtn").onclick = function () {
      const readingInput = document.getElementById("reading");
      const readingVal = readingInput.value.trim();
      if (!readingVal || isNaN(readingVal) || Number(readingVal) < 0) {
        alert("Please enter a valid blood sugar reading.");
        readingInput.focus();
        return;
      }

      const reading = parseFloat(readingVal);
      const unit = document.getElementById("unit").value;
      const name = document.getElementById("fullName").value.trim();
      const age = document.getElementById("age").value.trim();
      const gender = document.getElementById("gender").value;
      const city = document.getElementById("city").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const diabetesType = document.getElementById("diabetesType").value;

      if (diabetesType === "none") {
        alert("Please select a diabetes type.");
        return;
      }

      let converted = reading;
      if (unit === "mmol") {
        converted = reading * 18;
      }

      const suggestion = getSuggestions(converted, diabetesType);
      const resultBox = document.getElementById("result");
      resultBox.style.display = "block";
      resultBox.innerHTML = `
        <h3 style="color:${suggestion.color}">${suggestion.label}</h3>
        <p>${suggestion.message}</p>
        <p><strong>Reading:</strong> ${converted.toFixed(1)} mg/dL</p>
        <p><strong>Suggested Activity:</strong> ${suggestion.workout}</p>
        <p><strong>Food, Fruits & Juices Suggestions:</strong> ${suggestion.food}</p>
      `;

      const date = new Date().toLocaleString(); // ‚úÖ This line added to fix date

      const entry = {
        date,
        diabetesType: diabetesType, // <--- add this
        name: name || "-",
        age: age || "-",
        gender: gender || "-",
        city: city || "-",
        phone: phone || "-",
        email: email || "-",
        reading: converted.toFixed(1),
        status: suggestion.label,
        color: suggestion.color
      };

      saveToLocal(entry);
      refreshHistory();
    };

    document.getElementById("downloadCsv").onclick = function () {
      const history = JSON.parse(localStorage.getItem("sugarHistory") || "[]");
      if(history.length === 0) {
        alert("No data to download.");
        return;
      }
      const csv = [
        ["Date","Reading (mg/dL)","Diabetes-Type","Status","Name","Age","Gender","City","Phone","Email"],
        ...history.map(row => [
          `"${row.date}"`,
          `"${row.reading} mg/dL"`,
          `"${row.diabetesType}"`,
           `"${row.status}"`,
          `"${row.name}"`,
          `"${row.age}"`,
          `"${row.gender}"`,
          `"${row.city}"`,
          `"${row.phone}"`,
          `"${row.email}"`
         
        ])
      ].map(r => r.join(",")).join("\n");
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'blood_sugar_history.csv';
      a.click();
      URL.revokeObjectURL(url);
    };

    // Print functionality
    const printResults = document.getElementById('printResults');
     printResults.addEventListener('click', () => {
      window.print();
     });
   
    // On page load show last 100 checks automatically
    refreshHistory();
  </script>
</body>
</html>
